{"version":3,"file":"mini-vuex.js","sources":["../src/util.js","../src/moduleCollection.js","../src/store.js","../src/helpers.js"],"sourcesContent":["export function forEachValue(obj, callback) {\n  Object.keys(obj).forEach((key) => callback(obj[key], key));\n}\n\nexport function partial (fn, arg) {\n  return function () {\n    return fn(arg)\n  }\n}\n\nexport function isObject (obj) {\n  return obj !== null && typeof obj === 'object'\n}","import { forEachValue } from './util';\n\nexport default class ModuleCollection {\n  constructor(options) {\n    // console.log(options);\n    this.register([], options);\n  }\n\n  register(path, rootModule) {\n    // console.log(\n    //   '🚀 ~ file: moduleCollection.js ~ line 10 ~ ModuleCollection ~ register ~ path',\n    //   path\n    // );\n\n    let newModule = {\n      _rawModule: rootModule,\n      _children: {},\n      state: rootModule.state,\n    };\n\n    // 如果 path 空数组，表示是根\n    if (path.length === 0) {\n      this.root = newModule;\n    } else {\n      // 找到父亲，把儿子放到父亲下\n      const parent = path.slice(0, -1).reduce((root, curr) => {\n        return root._children[curr];\n      }, this.root);\n      // 拿到最后一个 （就是儿子）\n      parent._children[path[path.length - 1]] = newModule;\n    }\n\n    if (rootModule.modules) {\n      forEachValue(rootModule.modules, (rawChildModule, key) => {\n        this.register(path.concat(key), rawChildModule);\n      });\n    }\n  }\n}\n","import { forEachValue, partial } from './util';\nimport ModuleCollection from './moduleCollection';\n\nlet Vue;\n\nclass Store {\n  constructor(options) {\n    const state = options.state;\n    // getters\n    this.getters = {};\n    // mutations\n    this.mutations = {};\n    // actions\n    this.actions = {};\n\n    // 进行响应式, state 变化会触发更新 重新获取值（eg: getters）\n    this._vm = new Vue({\n      data: {\n        state: state,\n      },\n      // computed,\n    });\n\n    // 改变 this 指向\n    const { commit, dispatch } = this;\n\n    this.commit = (type, payload) => {\n      commit.call(this, type, payload);\n    };\n\n    this.dispatch = (type, payload) => {\n      dispatch.call(this, type, payload);\n    };\n\n    // 收集模块\n    this.modules = new ModuleCollection(options);\n    // console.log(\n    //   '🚀 ~ file: store.js ~ line 81 ~ Store ~ constructor ~ this.modules',\n    //   this.modules\n    // );\n\n    /**\n     * 安装模块\n     * 把 getters mutations actions 放到 this.$store 上\n     */\n    installModule(this, this.state, [], this.modules.root);\n  }\n\n  // 提交 mutation 的 commit 方法\n  commit(type, payload) {\n    this.mutations[type].forEach((fn) => {\n      fn(payload);\n    });\n  }\n\n  // 触发 action 的 dispatch 方法\n  dispatch(type, payload) {\n    this.actions[type](payload);\n  }\n\n  get state() {\n    return this._vm.state;\n  }\n}\n\n/**\n * 模块安装\n * @param {*} store 当前实例\n * @param {*} state 状态\n * @param {*} path 递归路径\n * @param {*} module 根module\n */\nfunction installModule(store, state, path, module) {\n  const isRoot = !path.length;\n\n  // 如果是子模块，把子模块状态放到父模块上\n  if (!isRoot) {\n    const parentState = path.slice(0, -1).reduce((state, curr) => {\n      return state[curr];\n    }, state);\n    // console.log(\n    //   '🚀 ~ file: store.js ~ line 81 ~ parentState ~ parentState',\n    //   parentState\n    // );\n    // 动态添加\n    Vue.set(parentState, path[path.length - 1], module.state);\n  }\n  // getters\n  const getters = module._rawModule.getters;\n  if (getters) {\n    forEachValue(getters, (fn, key) => {\n      // computed[key] = partial(fn, module.state);\n      Object.defineProperty(store.getters, key, {\n        get: () => {\n          console.log('---------------------', key);\n          return fn(module.state);\n        },\n      });\n    });\n  }\n\n  // mutations\n  const mutations = module._rawModule.mutations;\n  if (mutations) {\n    forEachValue(mutations, (fn, key) => {\n      // 用户传递过来的 mutation 放到 store 实例上\n      const arr = store.mutations[key] || (store.mutations[key] = []);\n      arr.push((payload) => {\n        fn(module.state, payload);\n      });\n    });\n  }\n\n  // actions\n  const actions = module._rawModule.actions;\n  if (actions) {\n    forEachValue(actions, (fn, key) => {\n      store.actions[key] = (payload) => fn(store, payload);\n    });\n  }\n\n  // 递归\n  forEachValue(module._children, (childModule, key) => {\n    // console.log(\n    //   '🚀 ~ file: store.js ~ line 168 ~ forEachValue ~ store, state, path.concat(key), childModule',\n    //   store,\n    //   state,\n    //   path.concat(key),\n    //   childModule\n    // );\n    installModule(store, state, path.concat(key), childModule);\n  });\n}\n\nconst install = (_Vue) => {\n  Vue = _Vue;\n\n  // 每个组件注入 this.$store\n  Vue.mixin({\n    beforeCreate() {\n      // console.log(this.$options.name, this);\n      // 根组件 有传入 store\n      if (this.$options && this.$options.store) {\n        this.$store = this.$options.store;\n      } else {\n        // 子组件可以取父组件上的 $store\n        this.$store = this.$parent && this.$parent.$store;\n      }\n    },\n  });\n};\n\n// export default {\n//   Store,\n//   install,\n// }\n\nexport { Store, install };\n","import { isObject } from './util';\n\nexport const mapState = function (states) {\n  const res = {};\n  normalizeMap(states).forEach(({ key, val }) => {    \n    res[key] = function () {\n      const state = this.$store.state;\n      const getters = this.$store.getters;\n      return typeof val === 'function'\n        ? val.apply(this, state, getters)\n        : state[val];\n    };\n  });\n\n  return res;\n};\n\nexport const mapGetter = function (getters) {\n  const res = {};\n  normalizeMap(getters).forEach(({ key, val }) => {    \n    res[key] = function () {\n      return this.$store.getters[val]\n    };\n  });\n\n  return res;\n}\n\nfunction normalizeMap(map) {\n  if (!(Array.isArray(map) || isObject(map))) {\n    return [];\n  }\n  return Array.isArray(map)\n    ? map.map((key) => ({ key, val: key }))\n    : Object.keys(map).map((key) => ({ key, val: map[key] }));\n}\n"],"names":[],"mappings":"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"}